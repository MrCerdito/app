import{r as i,u as Ce,j as e,F as we,a as ke,b as He,c as Oe,d as Ue,e as K,f as Ge,g as ie,h as Z,i as $e,k as Y,l as oe,m as Se,n as le,o as Be,p as Ze,q as We,s as Ee,t as re,v as ne,w as Je,x as Q,y as X,z as Fe,A as Ke,B as De,C as Ye,D as je,E as Xe,G as Qe,H as es,I as ss,R as as,J as ge,N as ve,K as ts}from"./vendor-react-0kkXrzjt.js";import{c as is,A as ls,m as Ne,u as W,w as ns,F as rs}from"./vendor-D2vd6NQ_.js";(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))V(c);new MutationObserver(c=>{for(const x of c)if(x.type==="childList")for(const v of x.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&V(v)}).observe(document,{childList:!0,subtree:!0});function _(c){const x={};return c.integrity&&(x.integrity=c.integrity),c.referrerPolicy&&(x.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?x.credentials="include":c.crossOrigin==="anonymous"?x.credentials="omit":x.credentials="same-origin",x}function V(c){if(c.ep)return;c.ep=!0;const x=_(c);fetch(c.href,x)}})();const os="https://jllpaadvylfajhprdpjb.supabase.co",cs="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbHBhYWR2eWxmYWpocHJkcGpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYzNzIyOTYsImV4cCI6MjA2MTk0ODI5Nn0.GvWZ_W4to0FJ6gwAV-ZGJpV8SAEGYNhCdL7OkUvmIQk",C=is(os,cs),ds="/assets/logo-Bplp92BY.jpg";function ms(){const[s,u]=i.useState(""),[_,V]=i.useState(""),[c,x]=i.useState(!1),[v,q]=i.useState(!1),[l,S]=i.useState(null),M=Ce(),D=async p=>{if(p.preventDefault(),S(null),q(!0),!s||!_){S("Por favor ingrese email y contrase√±a"),q(!1);return}try{const{error:L}=await C.auth.signInWithPassword({email:s,password:_});if(L)throw L;M("/dashboard")}catch(L){console.error("Login error:",L),S(L.message||"Error al iniciar sesi√≥n. Verifique sus credenciales.")}finally{q(!1)}};return e.jsx("div",{className:"login-container",children:e.jsxs("div",{className:"login-card",children:[e.jsxs("div",{className:"login-header",children:[e.jsx("img",{src:ds,alt:"Logo de la empresa",className:"login-logo"}),e.jsx("h1",{children:"Iniciar Sesi√≥n"}),e.jsx("p",{children:"Ingrese sus credenciales para acceder al sistema"})]}),l&&e.jsxs("div",{className:"error-message",children:[e.jsx(we,{className:"error-icon"}),e.jsx("span",{children:l})]}),e.jsxs("form",{onSubmit:D,className:"login-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:"Email"}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(ke,{className:"input-icon"}),e.jsx("input",{id:"email",type:"email",placeholder:"usuario@ejemplo.com",value:s,onChange:p=>u(p.target.value),required:!0})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"password",children:"Contrase√±a"}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(He,{className:"input-icon"}),e.jsx("input",{id:"password",type:c?"text":"password",placeholder:"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢",value:_,onChange:p=>V(p.target.value),required:!0,minLength:6}),e.jsx("button",{type:"button",className:"toggle-password",onClick:()=>x(!c),children:c?e.jsx(Oe,{}):e.jsx(Ue,{})})]})]}),e.jsx("button",{type:"submit",className:"login-button",disabled:v,children:v?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"spin"}),e.jsx("span",{children:"Iniciando sesi√≥n..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ge,{}),e.jsx("span",{children:"Iniciar Sesi√≥n"})]})}),e.jsx("div",{className:"login-footer"})]})]})})}const _e=({fuelTypes:s})=>{if(!s)return e.jsx("span",{className:"no-fuel",children:"N/A"});const u=s.replace(/[\[\]"]/g,"").split(",").map(_=>_.trim()).filter(_=>_);return e.jsx("div",{className:"fuel-types-container",children:u.map((_,V)=>e.jsx("span",{className:`fuel-badge ${_.toLowerCase().replace("√≥","o")}`,children:_},V))})},be=({status:s})=>{const u=_=>{switch(_==null?void 0:_.toLowerCase()){case"disponible":return"status-available";case"en taller":return"status-in-maintenance";case"en uso":return"status-in-use";default:return"status-unknown"}};return e.jsx("span",{className:`status-badge ${u(s)}`,children:s||"N/A"})},ye=s=>s?new Date(s).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"N/A";function hs(){var me,he,ue,pe,fe;const[s,u]=i.useState([]),[_,V]=i.useState(null),[c,x]=i.useState(null),[v,q]=i.useState(!0),[l,S]=i.useState(null),[M,D]=i.useState(null),[p,L]=i.useState(!1),[E,j]=i.useState(!1),[t,r]=i.useState({}),[w,m]=i.useState([]),[T,h]=i.useState(""),[,k]=i.useState(null),[P,F]=i.useState(null),[A,z]=i.useState({}),[n,d]=i.useState(""),[y,H]=i.useState(null),[B,o]=i.useState("");i.useEffect(()=>{(async()=>{q(!0);try{const{data:{user:g}}=await C.auth.getUser();let b=null;if(g){const{data:te,error:ze}=await C.from("staff").select("id, rol").eq("auth_id",(g==null?void 0:g.id)||"").single();!ze&&te?(h(te.rol.toLowerCase()),b=te.id,k(te.id)):h("admin")}let N=C.from("vehicles").select(`
    *,
    staff:driver_id (
      id,
      full_name,
      rol
    ),
    mileage:vehicle_mileage (
      total_kilometers
    ),
    notes_list:vehicle_notes (
      id,
      content,
      created_at,
      staff:staff_id (
        full_name
      )
    ),
    fuel_last:fuel (
      id,
      fecha,
      litros,
      kilometraje,
      created_at
    )
  `).order("created_at",{ascending:!1});T&&T!=="admin"&&b&&(N=N.or(`driver_id.eq.${b},driver_id.is.null`));const{data:I,error:U}=await N;let $=C.from("staff").select("id, full_name, rol").order("full_name",{ascending:!0});T&&T!=="admin"&&b&&($=$.eq("id",b));const{data:ae,error:xe}=await $;if(U||xe)throw U||xe;u(I||[]),m(ae||[]),x(!0)}catch(g){console.error("Error fetching data:",g),V("Error de conexi√≥n con la base de datos"),x(!1)}finally{q(!1)}})()},[T]);const f=()=>!T||T==="admin",R=a=>{S(a),r({...a,driver_id:a.driver_id||null}),j(!1)},G=()=>{S(null),j(!1)},O=async a=>{const{data:g,error:b}=await C.from("vehicle_notes").select("id, content, created_at, updated_at, staff:staff_id (full_name)").eq("vehicle_id",a).order("created_at",{ascending:!1});b?console.error("Error fetching notes:",b):z(N=>({...N,[a]:g}))},ee=async a=>{F(a),await O(a.id.toString())},se=async()=>{if(!P||!n.trim())return;const{data:{user:a}}=await C.auth.getUser(),{data:g}=await C.from("staff").select("id, full_name").eq("auth_id",(a==null?void 0:a.id)||"").single(),{data:b,error:N}=await C.from("vehicle_notes").insert({vehicle_id:P.id,staff_id:(g==null?void 0:g.id)||null,content:n}).select(`
        id,
        content,
        created_at,
        staff:staff_id (
          full_name
        )
      `).single();!N&&b&&(d(""),u(I=>I.map(U=>U.id===P.id?{...U,notes_list:[{id:b.id,content:b.content,created_at:b.created_at,staff:{full_name:(g==null?void 0:g.full_name)||"Desconocido"}},...U.notes_list||[]]}:U)),(l==null?void 0:l.id)===P.id&&S(I=>I?{...I,notes_list:[{id:b.id,content:b.content,created_at:b.created_at,staff:{full_name:(g==null?void 0:g.full_name)||"Desconocido"}},...I.notes_list||[]]}:null))},Le=async a=>{const{error:g}=await C.from("vehicle_notes").delete().eq("id",a);!g&&P&&(u(b=>b.map(N=>{var I;return N.id===P.id?{...N,notes_list:((I=N.notes_list)==null?void 0:I.filter(U=>U.id!==a))||[]}:N})),(l==null?void 0:l.id)===P.id&&S(b=>{var N;return b?{...b,notes_list:((N=b.notes_list)==null?void 0:N.filter(I=>I.id!==a))||[]}:null}),O(P.id.toString()))},Pe=(a,g)=>{H(a),o(g)},Ae=async()=>{if(!y||!B.trim()||!P)return;const{data:a,error:g}=await C.from("vehicle_notes").update({content:B,updated_at:new Date().toISOString()}).eq("id",y).select(`
        id,
        content,
        created_at,
        updated_at,
        staff:staff_id (
          full_name
        )
      `).single();!g&&a&&(H(null),o(""),u(b=>b.map(N=>{var I;return N.id===P.id?{...N,notes_list:((I=N.notes_list)==null?void 0:I.map(U=>U.id===y?{...U,content:a.content,created_at:a.updated_at||a.created_at}:U))||[]}:N})),(l==null?void 0:l.id)===P.id&&S(b=>{var N;return b?{...b,notes_list:((N=b.notes_list)==null?void 0:N.map(I=>I.id===y?{...I,content:a.content,created_at:a.updated_at||a.created_at}:I))||[]}:null}),O(P.id.toString()))},ce=()=>{F(null),d(""),H(null)},de=(a,g)=>{f()&&(g.stopPropagation(),D(a))},Me=()=>{D(null)},Ve=async()=>{if(!(!M||!f())){L(!0);try{const{error:a}=await C.from("vehicles").delete().eq("id",M.id);if(a)throw a;u(s.filter(g=>g.id!==M.id)),D(null),(l==null?void 0:l.id)===M.id&&G()}catch(a){console.error("Error deleting vehicle:",a),V("Error al eliminar el veh√≠culo")}finally{L(!1)}}},Te=a=>{f()&&(a.stopPropagation(),j(!0))},Ie=()=>{j(!1),l&&r({...l,driver_id:l.driver_id||null})},qe=a=>{if(!f())return;const g=t.fuel_types?t.fuel_types.replace(/[\[\]"]/g,"").split(",").map(N=>N.trim()).filter(N=>N):[],b=g.includes(a)?g.filter(N=>N!==a):[...g,a];r(N=>({...N,fuel_types:`[${b.join(",")}]`}))},J=a=>{if(!f())return;const{name:g,value:b}=a.target;r(N=>({...N,[g]:b}))},Re=async()=>{if(!(!l||!f()))try{const a=l.last_oil_change_km!==t.last_oil_change_km,{error:g}=await C.from("vehicles").update({plate:t.plate,model:t.model,status:t.status,fuel_types:t.fuel_types,itv_date:t.itv_date,last_oil_change_km:t.last_oil_change_km,next_oil_change_km:t.next_oil_change_km,notes:t.notes,driver_id:t.driver_id}).eq("id",l.id);if(g)throw g;if(a){const{error:I}=await C.from("vehicle_mileage").update({total_kilometers:0}).eq("vehicle_id",l.id);if(I)throw I}const{data:b,error:N}=await C.from("vehicles").select(`
          *,
          staff:driver_id (
            id,
            full_name,
            rol
          ),
          mileage:vehicle_mileage (
            total_kilometers
          )
        `).eq("id",l.id).single();if(N)throw N;u(s.map(I=>I.id===l.id?b:I)),S(b),alert("Cambios guardados correctamente"),j(!1)}catch(a){console.error("Error updating vehicle:",a),V("Error al actualizar el veh√≠culo")}};return e.jsxs("div",{className:`vehicle-list-container ${f()?"":"read-only-mode"}`,children:[e.jsxs("div",{className:"vehicle-list-header",children:[e.jsx("h2",{children:"Flota de Veh√≠culos"}),e.jsxs("div",{className:"vehicle-count",children:[s.length," ",s.length===1?"veh√≠culo":"veh√≠culos"]})]}),v&&e.jsx("div",{className:"loading-overlay",children:e.jsxs("div",{className:"loading-content",children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Cargando flota..."})]})}),_&&e.jsxs("div",{className:"error-message",children:[e.jsx("div",{className:"error-icon",children:"‚ö†Ô∏è"}),e.jsx("div",{className:"error-text",children:_})]}),!v&&!c&&!_&&e.jsx("div",{className:"connection-message",children:"No se pudo conectar a la base de datos de veh√≠culos."}),T&&T!=="admin"&&e.jsxs("div",{className:"read-only-notice",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z",clipRule:"evenodd"})}),e.jsx("span",{children:"Est√°s viendo solo los veh√≠culos asignados a ti"})]}),!v&&c&&e.jsx("div",{className:"vehicle-cards-container",children:s.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-icon",children:"üöó"}),e.jsx("div",{className:"empty-text",children:"No hay veh√≠culos registrados"})]}):e.jsx("div",{className:"vehicle-cards-grid",children:s.map(a=>{var g,b,N,I,U;return e.jsxs("div",{className:"vehicle-card",onClick:()=>R(a),children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"vehicle-icon",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M5 17H3V12H5M19 17H21V12H19M16 3H8L5 7V17H19V7L16 3Z",stroke:"#0F766E",strokeWidth:"1.5"}),e.jsx("path",{d:"M7.5 14C8.32843 14 9 13.3284 9 12.5C9 11.6716 8.32843 11 7.5 11C6.67157 11 6 11.6716 6 12.5C6 13.3284 6.67157 14 7.5 14Z",fill:"#0F766E"}),e.jsx("path",{d:"M16.5 14C17.3284 14 18 13.3284 18 12.5C18 11.6716 17.3284 11 16.5 11C15.6716 11 15 11.6716 15 12.5C15 13.3284 15.6716 14 16.5 14Z",fill:"#0F766E"})]})}),e.jsxs("div",{className:"vehicle-title",children:[e.jsx("h3",{children:a.model||"Veh√≠culo"}),e.jsx("div",{className:"vehicle-subtitle",children:a.plate||"Sin placa"})]}),e.jsx(be,{status:a.status})]}),e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"card-section",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Combustible"}),e.jsx("span",{className:"detail-value",children:e.jsx(_e,{fuelTypes:a.fuel_types})})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"ITV"}),e.jsx("span",{className:"detail-value",children:ye(a.itv_date)})]})]}),a.fuel_last&&a.fuel_last.length>0&&e.jsx("div",{className:"card-section",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"√öltimo repostaje"}),e.jsxs("span",{className:"detail-value",children:[a.fuel_last[0].kilometraje.toLocaleString()," km"]})]})}),e.jsxs("div",{className:"card-section",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Aceite (√∫ltimo)"}),e.jsx("span",{className:"detail-value",children:a.last_oil_change_km?`${a.last_oil_change_km.toLocaleString()} km`:"N/A"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Aceite (pr√≥ximo)"}),e.jsx("span",{className:`${(b=(g=a.fuel_last)==null?void 0:g[0])!=null&&b.kilometraje&&a.last_oil_change_km?a.fuel_last[0].kilometraje>=a.last_oil_change_km+15e3?"oil-critical":a.fuel_last[0].kilometraje>=a.last_oil_change_km+1e4?"oil-warning":"oil-normal":""}`,children:a.last_oil_change_km&&((I=(N=a.fuel_last)==null?void 0:N[0])!=null&&I.kilometraje)?(()=>{const $=a.last_oil_change_km+15e3-a.fuel_last[0].kilometraje;return $<=0?`Requiere cambio de aceite, ${Math.abs($).toLocaleString()} km`:`${$.toLocaleString()} km restantes para hacer el cambio de aceite`})():"N/A"})]})]}),e.jsx("div",{className:"card-section",children:e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Conductor"}),e.jsx("span",{className:"detail-value driver-name",children:((U=a.staff)==null?void 0:U.full_name)||"No asignado"})]})}),a.notes_list&&a.notes_list.length>0&&e.jsxs("div",{className:"card-notes-preview",children:[e.jsx("h4",{children:"Notas"}),e.jsx("ul",{className:"note-snippets",children:a.notes_list.map($=>{var ae;return e.jsxs("li",{className:"note-item",children:[e.jsx("span",{className:"note-text",children:$.content}),e.jsxs("span",{className:"note-author",children:["‚Äî ",((ae=$.staff)==null?void 0:ae.full_name)||"Anon."]})]},$.id)})})]})]}),f()&&e.jsxs("div",{className:"card-actions",children:[e.jsx("button",{onClick:$=>{$.stopPropagation(),ee(a)},className:"btn-action btn-edit",title:"Agregar nota",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"18",height:"18",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M21 11.5V4A2 2 0 0 0 19 2H7A2 2 0 0 0 5 4v16a2 2 0 0 0 2 2h10l4-4v-6.5zM17 20h-8V4h10v6h-2a1 1 0 0 0-1 1v9zm1-1.414V13h2v4.586L18.586 19zM8 6h8v2H8V6zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"})})}),e.jsx("button",{onClick:$=>de(a,$),className:"btn-action btn-delete",title:"Eliminar veh√≠culo",children:e.jsx("svg",{viewBox:"0 0 24 24",width:"18",height:"18",children:e.jsx("path",{fill:"currentColor",d:"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"})})})]})]},a.id)})})}),l&&e.jsx("div",{className:"vehicle-popup-overlay",onClick:G,children:e.jsxs("div",{className:"vehicle-popup-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"close-popup",onClick:G,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M18 6L6 18",stroke:"#64748B",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M6 6L18 18",stroke:"#64748B",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsxs("div",{className:"popup-header",children:[e.jsx("div",{className:"vehicle-icon",children:e.jsxs("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M5 17H3V12H5M19 17H21V12H19M16 3H8L5 7V17H19V7L16 3Z",stroke:"#0F766E",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:"M7.5 14C8.32843 14 9 13.3284 9 12.5C9 11.6716 8.32843 11 7.5 11C6.67157 11 6 11.6716 6 12.5C6 13.3284 6.67157 14 7.5 14Z",fill:"#0F766E"}),e.jsx("path",{d:"M16.5 14C17.3284 14 18 13.3284 18 12.5C18 11.6716 17.3284 11 16.5 11C15.6716 11 15 11.6716 15 12.5C15 13.3284 15.6716 14 16.5 14Z",fill:"#0F766E"})]})}),e.jsx("div",{children:E?e.jsx("input",{type:"text",name:"model",value:t.model||"",onChange:J,className:"edit-input",placeholder:"Modelo del veh√≠culo",disabled:!f()}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"popup-title",children:l.model||"Veh√≠culo"}),e.jsx("div",{className:"popup-subtitle",children:l.plate||"Sin placa"})]})})]}),e.jsx("div",{className:"popup-divider"}),e.jsxs("div",{className:"popup-details",children:[e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Informaci√≥n General"}),e.jsx("div",{className:"detail-grid",children:E?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Placa"}),e.jsx("input",{type:"text",name:"plate",value:t.plate||"",onChange:J,className:"edit-input",placeholder:"Placa del veh√≠culo",disabled:!f()})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Estado"}),e.jsxs("select",{name:"status",value:t.status||"",onChange:J,className:"edit-select",disabled:!f(),children:[e.jsx("option",{value:"Disponible",children:"Disponible"}),e.jsx("option",{value:"En taller",children:"En taller"}),e.jsx("option",{value:"En uso",children:"En uso"})]})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Combustible"}),e.jsx("div",{className:"fuel-buttons-container",children:["Diesel","Gasolina","GLP","GNC"].map(a=>{const b=(t.fuel_types?t.fuel_types.replace(/[\[\]"]/g,"").split(",").map(N=>N.trim()).filter(N=>N):[]).includes(a);return e.jsx("button",{type:"button",className:`fuel-button ${b?"active":""}`,onClick:()=>qe(a),disabled:!f(),children:a},a)})})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Pr√≥xima ITV"}),e.jsx("input",{type:"date",name:"itv_date",value:t.itv_date||"",onChange:J,className:"edit-input",disabled:!f()})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Placa"}),e.jsx("span",{className:"detail-value",children:l.plate||"N/A"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Estado"}),e.jsx("span",{className:"detail-value",children:e.jsx(be,{status:l.status})})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Combustible"}),e.jsx("span",{className:"detail-value",children:e.jsx(_e,{fuelTypes:l.fuel_types})})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Pr√≥xima ITV"}),e.jsx("span",{className:"detail-value",children:ye(l.itv_date)})]})]})})]}),e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Mantenimiento"}),e.jsx("div",{className:"detail-grid",children:E?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"√öltimo cambio aceite (km)"}),e.jsx("input",{type:"number",name:"last_oil_change_km",value:t.last_oil_change_km||"",onChange:J,className:"edit-input",placeholder:"Kilometraje",disabled:!f()})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Pr√≥ximo cambio aceite (km)"}),e.jsx("div",{className:"mileage-display",children:(me=l.mileage)!=null&&me.total_kilometers?`${l.mileage.total_kilometers.toLocaleString()} km (actual)`:"No hay datos de kilometraje"}),e.jsx("input",{type:"number",name:"next_oil_change_km",value:t.next_oil_change_km||"",onChange:J,className:"edit-input",placeholder:"Kilometraje manual",disabled:!!((he=l.mileage)!=null&&he.total_kilometers)||!f()})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"√öltimo cambio aceite"}),e.jsx("span",{className:"detail-value",children:l.last_oil_change_km?`${l.last_oil_change_km.toLocaleString()} km`:"N/A"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"√öltimo KM"}),e.jsx("span",{className:"detail-value",children:(pe=(ue=l.fuel_last)==null?void 0:ue[0])!=null&&pe.kilometraje?`${l.fuel_last[0].kilometraje.toLocaleString()} km`:"N/A"})]})]})})]}),e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Conductor"}),E?e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Asignar conductor"}),e.jsxs("select",{name:"driver_id",value:t.driver_id||"",onChange:J,className:"edit-select",disabled:!f(),children:[e.jsx("option",{value:"",children:"No asignado"}),w.map(a=>e.jsx("option",{value:a.id,children:a.full_name},a.id))]})]}):e.jsx("div",{className:"driver-info",children:((fe=l.staff)==null?void 0:fe.full_name)||"No asignado"})]})]}),e.jsx("div",{className:"popup-actions",children:E?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Ie,className:"btn-cancel",children:"Cancelar"}),f()&&e.jsx("button",{onClick:Re,className:"btn-save",children:"Guardar cambios"})]}):e.jsxs(e.Fragment,{children:[f()&&e.jsx("button",{onClick:Te,className:"btn-edit",children:"Editar veh√≠culo"}),f()&&e.jsx("button",{onClick:a=>{a.stopPropagation(),de(l,a)},className:"btn-delete",children:"Eliminar veh√≠culo"})]})})]})}),M&&f()&&e.jsx("div",{className:"delete-confirmation-overlay",children:e.jsxs("div",{className:"delete-confirmation-dialog",children:[e.jsxs("div",{className:"delete-dialog-header",children:[e.jsx("div",{className:"warning-icon",children:e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M12 9V11M12 15H12.01M5.07183 19H18.9282C20.4678 19 21.4301 17.3333 20.6603 16L13.7321 4C12.9623 2.66667 11.0378 2.66667 10.268 4L3.33977 16C2.56997 17.3333 3.53223 19 5.07183 19Z",stroke:"#DC2626",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx("h3",{children:"¬øEliminar veh√≠culo?"})]}),e.jsxs("div",{className:"delete-dialog-content",children:[e.jsxs("p",{children:["Est√°s a punto de eliminar el veh√≠culo ",e.jsx("strong",{children:M.model})," con placa ",e.jsx("strong",{children:M.plate}),"."]}),e.jsx("p",{children:"Esta acci√≥n no se puede deshacer."})]}),e.jsxs("div",{className:"delete-dialog-actions",children:[e.jsx("button",{onClick:Me,className:"cancel-btn",disabled:p,children:"Cancelar"}),e.jsx("button",{onClick:Ve,className:"confirm-delete-btn",disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"delete-spinner"}),"Eliminando..."]}):"Eliminar definitivamente"})]})]})}),P&&e.jsx("div",{className:"notes-popup-overlay",onClick:ce,children:e.jsxs("div",{className:"notes-popup-content",onClick:a=>a.stopPropagation(),children:[e.jsx("button",{className:"close-popup",onClick:ce,children:"‚úñ"}),e.jsxs("h3",{children:["Notas de ",P.model]}),e.jsx("div",{className:"notes-list",children:(A[P.id]||[]).map(a=>{var g;return e.jsxs("div",{className:"note-item",children:[e.jsxs("div",{className:"note-header",children:[e.jsx("span",{className:"note-author",children:((g=a.staff)==null?void 0:g.full_name)||"Autor desconocido"}),e.jsx("span",{className:"note-date",children:new Date(a.created_at).toLocaleString()})]}),y===a.id?e.jsxs(e.Fragment,{children:[e.jsx("textarea",{value:B,onChange:b=>o(b.target.value)}),e.jsx("button",{onClick:Ae,children:"Guardar"})]}):e.jsx("p",{children:a.content}),e.jsxs("div",{className:"note-actions",children:[e.jsx("button",{onClick:()=>Pe(a.id,a.content),children:"Editar"}),e.jsx("button",{onClick:()=>Le(a.id),children:"Eliminar"})]})]},a.id)})}),e.jsxs("div",{className:"note-add-section",children:[e.jsx("textarea",{placeholder:"Escribe una nueva nota...",value:n,onChange:a=>d(a.target.value)}),e.jsx("button",{onClick:se,children:"Agregar nota"})]})]})})]})}const us=()=>{const[s,u]=i.useState(null),[_,V]=i.useState(null),[c]=i.useState(!1),[x,v]=i.useState({}),[q,l]=i.useState(!0),[S,M]=i.useState(null),[D]=i.useState(null),[,p]=i.useState(!1);i.useEffect(()=>{(async()=>{l(!0);try{const{data:{user:w}}=await C.auth.getUser();if(!w)throw new Error("Usuario no autenticado");const{data:m,error:T}=await C.from("staff").select("*").eq("auth_id",w.id).single();if(T)throw T;if(u(m),v(m),p(!0),m.assigned_vehicle_id){const{data:h,error:k}=await C.from("vehicles").select("id, plate, model, status").eq("id",m.assigned_vehicle_id).single();k||V(h)}}catch(w){console.error("Error fetching profile data:",w),M("Error al cargar los datos del perfil")}finally{l(!1)}})()},[]);const L=r=>{const{name:w,value:m}=r.target;v(T=>({...T,[w]:m}))},E=r=>r?new Date(r).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"}):"N/A",j=r=>r===null?"N/A":new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(r),t=({status:r})=>{const w=m=>{switch(m==null?void 0:m.toLowerCase()){case"disponible":return"status-available";case"en taller":return"status-in-maintenance";case"en uso":return"status-in-use";default:return"status-unknown"}};return e.jsx("span",{className:`status-badge ${w(r)}`,children:r||"N/A"})};return q?e.jsxs("div",{className:"profilep-loading",children:[e.jsx("div",{className:"profilep-spinner"}),e.jsx("p",{children:"Cargando perfil..."})]}):S?e.jsxs("div",{className:"profilep-error",children:[e.jsx("div",{className:"profilep-error-icon",children:"‚ö†Ô∏è"}),e.jsx("div",{className:"profilep-error-text",children:S}),e.jsx("button",{className:"profilep-btn-retry",onClick:()=>window.location.reload(),children:"Intentar de nuevo"})]}):s?e.jsxs("div",{className:"profilep-container",children:[D&&e.jsxs("div",{className:"profilep-success-message",children:[e.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z",stroke:"#047857",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})}),e.jsx("span",{children:D})]}),e.jsxs("div",{className:"profilep-header",children:[e.jsx("div",{className:"profilep-avatar-container",children:s.profile_picture_url?e.jsx("img",{src:s.profile_picture_url,alt:"Foto de perfil",className:"profilep-avatar"}):e.jsx("div",{className:"profilep-avatar",children:e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[e.jsx("path",{d:"M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z",fill:"#0F766E"}),e.jsx("path",{d:"M12 14C7.58172 14 4 17.5817 4 22H20C20 17.5817 16.4183 14 12 14Z",fill:"#0F766E"})]})})}),e.jsxs("div",{className:"profilep-title",children:[c?e.jsx("input",{type:"text",name:"full_name",value:x.full_name||"",onChange:L,className:"profilep-edit-input profilep-large",placeholder:"Nombre completo"}):e.jsx("h1",{children:s.full_name||"Usuario sin nombre"}),e.jsxs("div",{className:"profilep-subtitle",children:[s.position||"Sin puesto asignado"," ‚Ä¢ ",s.rol||"Sin rol asignado"]})]})]}),e.jsxs("div",{className:"profilep-content",children:[e.jsxs("div",{className:"profilep-section",children:[e.jsx("h2",{className:"profilep-section-title",children:"Informaci√≥n Personal"}),e.jsxs("div",{className:"profilep-info-grid",children:[e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Nombre de usuario"}),e.jsx("span",{className:"profilep-info-value",children:s.username||"N/A"})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Correo electr√≥nico"}),e.jsx("span",{className:"profilep-info-value",children:s.email||"N/A"})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Fecha de ingreso"}),e.jsx("span",{className:"profilep-info-value",children:E(s.start_date)})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Salario"}),e.jsx("span",{className:"profilep-info-value",children:j(s.salary)})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Contacto"}),c?e.jsx("input",{type:"tel",name:"contact",value:x.contact||"",onChange:L,className:"profilep-edit-input",placeholder:"N√∫mero de contacto"}):e.jsx("span",{className:"profilep-info-value",children:s.contact||"N/A"})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Direcci√≥n"}),c?e.jsx("textarea",{name:"address",value:x.address||"",onChange:L,className:"profilep-edit-textarea",placeholder:"Direcci√≥n completa",rows:2}):e.jsx("span",{className:"profilep-info-value",children:s.address||"N/A"})]})]})]}),e.jsxs("div",{className:"profilep-section",children:[e.jsx("h2",{className:"profilep-section-title",children:"Contacto de Emergencia"}),e.jsxs("div",{className:"profilep-info-grid",children:[e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Nombre"}),c?e.jsx("input",{type:"text",name:"emergency_contact_name",value:x.emergency_contact_name||"",onChange:L,className:"profilep-edit-input",placeholder:"Nombre del contacto"}):e.jsx("span",{className:"profilep-info-value",children:s.emergency_contact_name||"N/A"})]}),e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"Tel√©fono"}),c?e.jsx("input",{type:"tel",name:"emergency_contact",value:x.emergency_contact||"",onChange:L,className:"profilep-edit-input",placeholder:"Tel√©fono de emergencia"}):e.jsx("span",{className:"profilep-info-value",children:s.emergency_contact||"N/A"})]})]})]}),_&&e.jsxs("div",{className:"profilep-section",children:[e.jsx("h2",{className:"profilep-section-title",children:"Veh√≠culo Asignado"}),e.jsxs("div",{className:"profilep-vehicle-card",children:[e.jsx("div",{className:"profilep-vehicle-icon",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",children:[e.jsx("path",{d:"M5 17H3V12H5M19 17H21V12H19M16 3H8L5 7V17H19V7L16 3Z",stroke:"#0F766E",strokeWidth:"1.5"}),e.jsx("path",{d:"M7.5 14C8.32843 14 9 13.3284 9 12.5C9 11.6716 8.32843 11 7.5 11C6.67157 11 6 11.6716 6 12.5C6 13.3284 6.67157 14 7.5 14Z",fill:"#0F766E"}),e.jsx("path",{d:"M16.5 14C17.3284 14 18 13.3284 18 12.5C18 11.6716 17.3284 11 16.5 11C15.6716 11 15 11.6716 15 12.5C15 13.3284 15.6716 14 16.5 14Z",fill:"#0F766E"})]})}),e.jsxs("div",{className:"profilep-vehicle-info",children:[e.jsx("h3",{children:_.model}),e.jsx("div",{className:"profilep-vehicle-plate",children:_.plate}),e.jsx("div",{className:"profilep-vehicle-status",children:e.jsx(t,{status:_.status})})]})]})]})]}),e.jsxs("div",{className:"profilep-section",children:[e.jsx("h2",{className:"profilep-section-title",children:"D√≠as de descanso"}),e.jsx("div",{className:"profilep-info-grid",children:e.jsxs("div",{className:"profilep-info-item",children:[e.jsx("span",{className:"profilep-info-label",children:"D√≠as asignados"}),e.jsx("span",{className:"profilep-info-value",children:s.days_off&&s.days_off.length>0?s.days_off.join(", "):"No asignados"})]})})]})]}):e.jsxs("div",{className:"profilep-not-found",children:[e.jsx("div",{className:"profilep-not-found-icon",children:"üë§"}),e.jsx("div",{className:"profilep-not-found-text",children:"No se encontr√≥ el perfil del usuario"})]})};function ps(){const[s,u]=i.useState({plate:"",model:"",status:"disponible",fuel_types:["Diesel"],itv_date:"",last_oil_change_km:"",notes:"",driver_id:""}),[_,V]=i.useState([]),[c,x]=i.useState(!1),[v,q]=i.useState(!1),[l,S]=i.useState(null),[M,D]=i.useState(!1);i.useEffect(()=>{(async()=>{q(!0);try{const{data:r,error:w}=await C.from("staff").select("id, full_name").order("full_name",{ascending:!0});if(w)throw w;V(r)}catch(r){S("Error al cargar conductores: "+r.message)}finally{q(!1)}})()},[]);const p=t=>{const{name:r,value:w}=t.target;u(m=>({...m,[r]:w}))},L=t=>{u(r=>r.fuel_types.includes(t)?r.fuel_types.length>1?{...r,fuel_types:r.fuel_types.filter(w=>w!==t)}:r:{...r,fuel_types:[...r.fuel_types,t]})},E=()=>{const{plate:t,model:r,status:w,fuel_types:m,last_oil_change_km:T}=s;return!t.trim()||!r.trim()||!w||m.length===0?"Matr√≠cula, Modelo, Estado y al menos 1 combustible son obligatorios.":/^[A-Z0-9]{6,8}$/i.test(t.trim())?T&&isNaN(Number(T))?"Kilometraje de cambio de aceite debe ser un n√∫mero.":s.itv_date&&new Date(s.itv_date)<new Date?"La ITV no puede ser una fecha pasada.":null:"La matr√≠cula debe tener 6-8 caracteres alfanum√©ricos."},j=async t=>{t.preventDefault(),S(null),D(!1);const r=E();if(r){S(r);return}x(!0);try{const w={plate:s.plate.trim().toUpperCase(),model:s.model.trim(),status:s.status,fuel_types:s.fuel_types,itv_date:s.itv_date||null,last_oil_change_km:s.last_oil_change_km?parseInt(s.last_oil_change_km,10):null,notes:s.notes.trim()||null,driver_id:s.driver_id||null},{error:m}=await C.from("vehicles").insert([w]);if(m)throw m;D(!0),u({plate:"",model:"",status:"disponible",fuel_types:["Diesel"],itv_date:"",last_oil_change_km:"",notes:"",driver_id:""}),setTimeout(()=>D(!1),3e3)}catch(w){S("Error al guardar: "+w.message)}finally{x(!1)}};return e.jsx("div",{className:"form-container",children:e.jsxs("div",{className:"form-card",children:[e.jsx("h2",{className:"form-title",children:"Registrar Veh√≠culo"}),l&&e.jsxs("div",{className:"error-message animate__animated animate__shakeX",children:["‚ö†Ô∏è ",l]}),M&&e.jsx("div",{className:"success-message animate__animated animate__fadeIn",children:"‚úÖ Veh√≠culo registrado correctamente"}),e.jsxs("form",{onSubmit:j,className:"vehicle-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"plate",children:"Matr√≠cula*"}),e.jsx("input",{id:"plate",name:"plate",placeholder:"Ej: ABC1234",value:s.plate,onChange:p,required:!0,maxLength:8,pattern:"[A-Z0-9]{6,8}",title:"6-8 caracteres alfanum√©ricos"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"model",children:"Modelo*"}),e.jsx("input",{id:"model",name:"model",placeholder:"Ej: Toyota Hilux 2023",value:s.model,onChange:p,required:!0})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"status",children:"Estado*"}),e.jsxs("select",{id:"status",name:"status",value:s.status,onChange:p,required:!0,children:[e.jsx("option",{value:"disponible",children:"Disponible"}),e.jsx("option",{value:"en_ruta",children:"En ruta"}),e.jsx("option",{value:"en_taller",children:"En taller"}),e.jsx("option",{value:"mantenimiento",children:"Mantenimiento"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Combustible*"}),e.jsx("div",{className:"fuel-buttons-container",children:["Diesel","Gasolina","GLP","GNC"].map(t=>e.jsx("button",{type:"button",className:`fuel-button ${s.fuel_types.includes(t)?"active":""}`,onClick:()=>L(t),children:t},t))})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"itv_date",children:"Pr√≥xima ITV"}),e.jsx("input",{type:"date",id:"itv_date",name:"itv_date",value:s.itv_date,onChange:p,min:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"last_oil_change_km",children:"√ölt. cambio de aceite (km)"}),e.jsx("input",{type:"number",id:"last_oil_change_km",name:"last_oil_change_km",placeholder:"Ej: 50000",value:s.last_oil_change_km,onChange:p})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"notes",children:"Notas"}),e.jsx("textarea",{id:"notes",name:"notes",placeholder:"Observaciones del veh√≠culo...",value:s.notes,onChange:p,rows:3})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"driver_id",children:"Conductor"}),e.jsxs("select",{id:"driver_id",name:"driver_id",value:s.driver_id,onChange:p,disabled:v,children:[e.jsx("option",{value:"",children:"Seleccionar conductor..."}),v?e.jsx("option",{disabled:!0,children:"Cargando..."}):_.map(t=>e.jsx("option",{value:t.id,children:t.full_name},t.id))]})]}),e.jsx("button",{type:"submit",className:"submit-button",disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner"}),"Guardando..."]}):"Registrar Veh√≠culo"})]})]})})}const fs=[{id:"Lunes",label:"Lunes"},{id:"Martes",label:"Martes"},{id:"Mi√©rcoles",label:"Mi√©rcoles"},{id:"Jueves",label:"Jueves"},{id:"Viernes",label:"Viernes"},{id:"S√°bado",label:"S√°bado"},{id:"Domingo",label:"Domingo"}],xs=()=>{var B;const[s,u]=i.useState([]),[_,V]=i.useState(!0),[c,x]=i.useState(null),[v,q]=i.useState(""),[l,S]=i.useState(null),[M,D]=i.useState(null),[p,L]=i.useState(!1),[E,j]=i.useState(!1),[t,r]=i.useState({});i.useEffect(()=>{(async()=>{V(!0),x(null);try{const{data:f,error:R}=await C.from("staff").select("*").order("full_name",{ascending:!0});if(R)throw R;u(f)}catch(f){console.error("Error fetching staff:",f),x("Error al cargar el personal. Intente nuevamente.")}finally{V(!1)}})()},[]);const w=o=>{const f={year:"numeric",month:"short",day:"numeric"};return new Date(o).toLocaleDateString("es-ES",f)},m=o=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(o),T=o=>{S(o),r({...o}),j(!1)},h=()=>{S(null),j(!1)},k=(o,f)=>{f.stopPropagation(),D(o)},P=()=>{D(null)},F=o=>{r(f=>{const R=f.days_off||[],G=R.includes(o)?R.filter(O=>O!==o):[...R,o];return{...f,days_off:G}})},A=async()=>{if(M){L(!0);try{const{error:o}=await C.from("staff").delete().eq("id",M.id);if(o)throw o;u(s.filter(f=>f.id!==M.id)),D(null),(l==null?void 0:l.id)===M.id&&h()}catch(o){console.error("Error deleting staff:",o),x("Error al eliminar el personal. Intente nuevamente.")}finally{L(!1)}}},z=o=>{o.stopPropagation(),j(!0)},n=()=>{j(!1),l&&r({...l})},d=o=>{const{name:f,value:R}=o.target;r(G=>({...G,[f]:R}))},y=async()=>{if(l)try{const{data:o,error:f}=await C.from("staff").update({full_name:t.full_name,username:t.username,position:t.position,salary:t.salary,contact:t.contact,address:t.address,emergency_contact:t.emergency_contact,emergency_contact_name:t.emergency_contact_name,start_date:t.start_date,days_off:t.days_off}).eq("id",l.id).select("*");if(f)throw f;u(s.map(R=>R.id===l.id?o[0]:R)),S(o[0]),j(!1)}catch(o){console.error("Error updating staff:",o),x("Error al actualizar el personal. Intente nuevamente.")}},H=s.filter(o=>o.full_name.toLowerCase().includes(v.toLowerCase())||o.position.toLowerCase().includes(v.toLowerCase())||o.username.toLowerCase().includes(v.toLowerCase()));return _?e.jsxs("div",{className:"loading-container",children:[e.jsx(K,{className:"spin",size:24}),e.jsx("p",{children:"Cargando personal..."})]}):c?e.jsxs("div",{className:"error-container",children:[e.jsx(ie,{size:24}),e.jsx("p",{children:c})]}):e.jsxs("div",{className:"personnel-list-container",children:[e.jsxs("div",{className:"header-section",children:[e.jsxs("h2",{children:[e.jsx(Z,{className:"header-icon"}),"Gesti√≥n de Personal"]}),e.jsx("div",{className:"actions-bar",children:e.jsxs("div",{className:"search-container",children:[e.jsx($e,{className:"search-icon"}),e.jsx("input",{type:"text",placeholder:"Buscar personal...",value:v,onChange:o=>q(o.target.value)})]})})]}),H.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-icon",children:"üë§"}),e.jsx("div",{className:"empty-text",children:v?`No se encontraron resultados para "${v}"`:"No hay personal registrado"})]}):e.jsx("div",{className:"staff-cards-grid",children:H.map(o=>e.jsxs("div",{className:"staff-card",onClick:()=>T(o),children:[e.jsxs("div",{className:"card-header",children:[e.jsx("div",{className:"staff-avatar",children:e.jsx(Z,{size:20})}),e.jsxs("div",{className:"staff-info",children:[e.jsx("h3",{children:o.full_name}),e.jsx("p",{className:"position",children:o.position})]}),e.jsx(js,{status:o.position})]}),e.jsxs("div",{className:"card-content",children:[e.jsxs("div",{className:"info-row",children:[e.jsx(Z,{className:"icon"}),e.jsx("span",{className:"truncate",children:o.email})]}),e.jsxs("div",{className:"info-row",children:[e.jsx(Y,{className:"icon"}),e.jsx("span",{children:w(o.start_date)})]}),e.jsxs("div",{className:"info-row",children:[e.jsx(oe,{className:"icon"}),e.jsx("span",{children:m(o.salary)})]})]}),o.days_off&&o.days_off.length>0&&e.jsxs("div",{className:"info-row",children:[e.jsx(Y,{className:"icon"}),e.jsxs("span",{children:["D√≠as de descanso: ",o.days_off.join(", ")]})]}),e.jsx("div",{className:"card-actions"})]},o.id))}),e.jsxs("div",{className:"summary-footer",children:["Mostrando ",H.length," de ",s.length," empleados"]}),l&&e.jsx("div",{className:"staff-popup-overlay",onClick:h,children:e.jsxs("div",{className:"staff-popup-content",onClick:o=>o.stopPropagation(),children:[e.jsx("button",{className:"close-popup",onClick:h,children:e.jsx(Se,{size:20})}),e.jsxs("div",{className:"popup-header",children:[e.jsx("div",{className:"staff-avatar",children:e.jsx(Z,{size:28})}),e.jsx("div",{children:E?e.jsx("input",{type:"text",name:"full_name",value:t.full_name||"",onChange:d,className:"edit-input",placeholder:"Nombre completo"}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{className:"popup-title",children:l.full_name}),e.jsx("div",{className:"popup-subtitle",children:l.position})]})})]}),e.jsx("div",{className:"popup-divider"}),e.jsxs("div",{className:"popup-details",children:[e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Informaci√≥n B√°sica"}),E?e.jsxs("div",{className:"edit-grid",children:[e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Usuario"}),e.jsx("input",{type:"text",name:"username",value:t.username||"",onChange:d,className:"edit-input",placeholder:"Nombre de usuario"})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Posici√≥n"}),e.jsx("input",{type:"text",name:"position",value:t.position||"",onChange:d,className:"edit-input",placeholder:"Posici√≥n/Cargo"})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Salario"}),e.jsx("input",{type:"number",name:"salary",value:t.salary||"",onChange:d,className:"edit-input",placeholder:"Salario"})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Fecha de Inicio"}),e.jsx("input",{type:"date",name:"start_date",value:t.start_date||"",onChange:d,className:"edit-input"})]})]}):e.jsxs("div",{className:"detail-grid",children:[e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Usuario:"}),e.jsx("span",{className:"detail-value truncate",children:l.email})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Fecha Inicio:"}),e.jsx("span",{className:"detail-value",children:w(l.start_date)})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx("span",{className:"detail-label",children:"Salario:"}),e.jsx("span",{className:"detail-value",children:m(l.salary)})]})]})]}),e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Contacto"}),E?e.jsxs("div",{className:"edit-grid",children:[e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Tel√©fono"}),e.jsx("input",{type:"text",name:"contact",value:t.contact||"",onChange:d,className:"edit-input",placeholder:"N√∫mero de contacto"})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Direcci√≥n"}),e.jsx("input",{type:"text",name:"address",value:t.address||"",onChange:d,className:"edit-input",placeholder:"Direcci√≥n"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(le,{className:"detail-icon"}),e.jsx("span",{className:"truncate",children:l.contact||"No especificado"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(Be,{className:"detail-icon"}),e.jsx("span",{className:"truncate",children:l.address||"No especificado"})]})]})]}),e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"Contacto de Emergencia"}),E?e.jsxs("div",{className:"edit-grid",children:[e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Nombre"}),e.jsx("input",{type:"text",name:"emergency_contact_name",value:t.emergency_contact_name||"",onChange:d,className:"edit-input",placeholder:"Nombre contacto emergencia"})]}),e.jsxs("div",{className:"edit-field",children:[e.jsx("label",{children:"Tel√©fono"}),e.jsx("input",{type:"text",name:"emergency_contact",value:t.emergency_contact||"",onChange:d,className:"edit-input",placeholder:"Tel√©fono emergencia"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"detail-item",children:[e.jsx(Z,{className:"detail-icon"}),e.jsx("span",{className:"truncate",children:l.emergency_contact_name||"No especificado"})]}),e.jsxs("div",{className:"detail-item",children:[e.jsx(le,{className:"detail-icon"}),e.jsx("span",{className:"truncate",children:l.emergency_contact||"No especificado"})]})]})]}),e.jsxs("div",{className:"detail-section",children:[e.jsx("h4",{className:"section-title",children:"D√≠as de descanso"}),E?e.jsx("div",{className:"days-off-options",children:fs.map(o=>{var f;return e.jsxs("label",{className:"day-off-option",children:[e.jsx("input",{type:"checkbox",checked:((f=t.days_off)==null?void 0:f.includes(o.id))||!1,onChange:()=>F(o.id)}),o.label]},o.id)})}):e.jsxs("div",{className:"detail-item",children:[e.jsx(Y,{className:"detail-icon"}),e.jsx("span",{children:((B=l.days_off)==null?void 0:B.join(", "))||"No asignado"})]})]})]}),e.jsx("div",{className:"popup-actions",children:E?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:n,className:"btn-cancel",children:"Cancelar"}),e.jsxs("button",{onClick:y,className:"btn-save",children:[e.jsx(Ze,{size:16}),e.jsx("span",{children:"Guardar"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:o=>{o.stopPropagation(),z(o)},className:"btn-edit",children:[e.jsx(We,{size:16}),e.jsx("span",{children:"Editar"})]}),e.jsxs("button",{onClick:o=>{o.stopPropagation(),k(l,o)},className:"btn-delete",children:[e.jsx(Ee,{size:16}),e.jsx("span",{children:"Eliminar"})]})]})})]})}),M&&e.jsx("div",{className:"delete-confirmation-overlay",children:e.jsxs("div",{className:"delete-confirmation-dialog",children:[e.jsxs("div",{className:"delete-dialog-header",children:[e.jsx("div",{className:"warning-icon",children:e.jsx(ie,{size:24})}),e.jsx("h3",{children:"¬øEliminar personal?"})]}),e.jsxs("div",{className:"delete-dialog-content",children:[e.jsxs("p",{children:["Est√°s a punto de eliminar a ",e.jsx("strong",{children:M.full_name})," (",M.position,")."]}),e.jsx("p",{children:"Esta acci√≥n no se puede deshacer."})]}),e.jsxs("div",{className:"delete-dialog-actions",children:[e.jsx("button",{onClick:P,className:"cancel-btn",disabled:p,children:"Cancelar"}),e.jsx("button",{onClick:A,className:"confirm-delete-btn",disabled:p,children:p?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"spin",size:16}),e.jsx("span",{children:"Eliminando..."})]}):"Eliminar"})]})]})})]})},js=({status:s})=>{const u=()=>s?s.toLowerCase().includes("gerente")||s.toLowerCase().includes("manager")?"blue":s.toLowerCase().includes("supervisor")?"green":s.toLowerCase().includes("asistente")?"purple":"gray":"gray";return e.jsx("span",{className:`status-badge ${u()}`,children:s||"N/A"})};function gs(){const[s,u]=i.useState({full_name:"",username:"",start_date:"",salary:"",contact:"",address:"",emergency_contact:"",emergency_contact_name:"",position:"",password:"",confirm_password:"",assigned_vehicle_id:"",rol:"staff",email:"",days_off:[]}),_=[{id:"Lunes",label:"Lunes"},{id:"Martes",label:"Martes"},{id:"Mi√©rcoles",label:"Mi√©rcoles"},{id:"Jueves",label:"Jueves"},{id:"Viernes",label:"Viernes"},{id:"S√°bado",label:"S√°bado"},{id:"Domingo",label:"Domingo"}],V=h=>{u(k=>{const P=k.days_off.includes(h)?k.days_off.filter(F=>F!==h):[...k.days_off,h];return{...k,days_off:P}})},[c,x]=i.useState(!1),[v,q]=i.useState(null),[l,S]=i.useState(!1),[M,D]=i.useState(0),[p,L]=i.useState(null),[E,j]=i.useState([]),[t,r]=i.useState(!1);i.useEffect(()=>{(async()=>{r(!0);try{const{data:k,error:P}=await C.from("vehicles").select("id, model, plate, status").eq("status","disponible");if(P)throw P;k&&j(k)}catch(k){console.error("Error fetching vehicles:",k)}finally{r(!1)}})()},[]);const w=h=>{if(!h){D(0);return}let k=0;h.length>=8&&(k+=1),/[A-Z]/.test(h)&&(k+=1),/[0-9]/.test(h)&&(k+=1),/[^A-Za-z0-9]/.test(h)&&(k+=1),D(k)},m=h=>{const{name:k,value:P}=h.target;u(F=>({...F,[k]:P})),k==="password"&&w(P)},T=async h=>{var k;if(h.preventDefault(),q(null),S(!1),!s.full_name||!s.username||!s.start_date||!s.salary||!s.password||!s.confirm_password||!s.position){q("Por favor complete todos los campos obligatorios");return}if(s.password!==s.confirm_password){q("Las contrase√±as no coinciden");return}if(M<2){q("La contrase√±a es demasiado d√©bil (debe incluir al menos 8 caracteres, una may√∫scula y un n√∫mero)");return}x(!0);try{const[P,F]=s.full_name.split(" "),A=`${P.toLowerCase()}.${F.toLowerCase()}@positlogis.app`;L(A);const{data:z,error:n}=await C.auth.signUp({email:A,password:s.password,options:{data:{full_name:s.full_name,username:s.username,role:"staff"}}});if(n)throw n;const d=(k=z.user)==null?void 0:k.id;if(!d)throw new Error("No se pudo obtener el ID de autenticaci√≥n");const{error:y}=await C.from("staff").insert([{full_name:s.full_name,username:s.username,start_date:s.start_date,salary:parseFloat(s.salary),contact:s.contact,address:s.address,emergency_contact:s.emergency_contact,emergency_contact_name:s.emergency_contact_name,assigned_vehicle_id:s.assigned_vehicle_id||null,position:s.position,auth_id:d,rol:s.rol,email:A,days_off:s.days_off.length>0?s.days_off:null}]);if(y)throw y;S(!0),u({full_name:"",username:"",start_date:"",salary:"",contact:"",address:"",emergency_contact:"",emergency_contact_name:"",position:"",password:"",confirm_password:"",assigned_vehicle_id:"",rol:"staff",email:"",days_off:[]})}catch(P){q(P.message||"Error al registrar el usuario")}finally{x(!1)}};return e.jsx("div",{className:"personnel-form-container",children:e.jsxs("div",{className:"form-card",children:[e.jsxs("div",{className:"form-header",children:[e.jsx(Z,{className:"form-icon"}),e.jsx("h2",{children:"Registro de Personal"}),e.jsx("p",{className:"form-subtitle",children:"Complete los datos del nuevo miembro del equipo"})]}),v&&e.jsxs("div",{className:"alert error",children:[e.jsx(Se,{className:"alert-icon"}),e.jsx("span",{children:v})]}),l&&e.jsxs("div",{className:"alert success",children:[e.jsx(re,{className:"alert-icon"}),e.jsx("span",{children:"¬°Registro exitoso! Credenciales enviadas al email."}),p&&e.jsxs("div",{className:"assigned-email",children:[e.jsx(ke,{className:"email-icon"}),e.jsx("span",{children:p}),e.jsx("button",{onClick:()=>navigator.clipboard.writeText(p),className:"copy-btn",children:"Copiar"})]})]}),e.jsxs("form",{onSubmit:T,className:"personnel-form",children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"full_name",children:[e.jsx(Z,{className:"input-icon"})," Nombre completo ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{id:"full_name",name:"full_name",placeholder:"Ej: Juan P√©rez",value:s.full_name,onChange:m,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"username",children:[e.jsx(Z,{className:"input-icon"})," Nombre de usuario ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{id:"username",name:"username",placeholder:"Ej: juan.perez",value:s.username,onChange:m,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"position",children:[e.jsx(Z,{className:"input-icon"})," Cargo/Puesto ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{id:"position",name:"position",placeholder:"Ej: Conductor, Operador",value:s.position,onChange:m,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"start_date",children:[e.jsx(Y,{className:"input-icon"})," Fecha de inicio ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"date",id:"start_date",name:"start_date",value:s.start_date,onChange:m,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"salary",children:[e.jsx(ne,{className:"input-icon"})," Salario ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"number",id:"salary",name:"salary",placeholder:"Ej: 2500.00",value:s.salary,onChange:m,required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"contact",children:[e.jsx(le,{className:"input-icon"})," Tel√©fono de contacto"]}),e.jsx("input",{id:"contact",name:"contact",placeholder:"Ej: +51 987654321",value:s.contact,onChange:m})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"address",children:[e.jsx(Je,{className:"input-icon"})," Direcci√≥n"]}),e.jsx("input",{id:"address",name:"address",placeholder:"Ej: Av. Principal 123",value:s.address,onChange:m})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"emergency_contact",children:[e.jsx(le,{className:"input-icon"})," Contacto de emergencia"]}),e.jsx("input",{id:"emergency_contact",name:"emergency_contact",placeholder:"Ej: +51 987654321",value:s.emergency_contact,onChange:m})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"emergency_contact_name",children:[e.jsx(Z,{className:"input-icon"})," Nombre contacto emergencia"]}),e.jsx("input",{id:"emergency_contact_name",name:"emergency_contact_name",placeholder:"Ej: Mar√≠a L√≥pez",value:s.emergency_contact_name,onChange:m})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"assigned_vehicle_id",children:[e.jsx(Q,{className:"input-icon"})," Veh√≠culo asignado"]}),e.jsxs("select",{id:"assigned_vehicle_id",name:"assigned_vehicle_id",value:s.assigned_vehicle_id,onChange:m,disabled:t,children:[e.jsx("option",{value:"",children:"Seleccione un veh√≠culo"}),E.map(h=>e.jsxs("option",{value:h.id,children:[h.model," - ",h.plate]},h.id))]}),t&&e.jsx(K,{className:"loading-icon small"})]}),e.jsxs("div",{className:"form-group days-off-group",children:[e.jsx("label",{children:"D√≠as de descanso"}),e.jsx("div",{className:"days-off-options",children:_.map(h=>e.jsxs("div",{className:"day-off-option",children:[e.jsx("input",{type:"checkbox",id:`day-off-${h.id}`,checked:s.days_off.includes(h.id),onChange:()=>V(h.id)}),e.jsx("label",{htmlFor:`day-off-${h.id}`,children:h.label})]},h.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"password",children:[e.jsx(ne,{className:"input-icon"})," Contrase√±a ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"password",id:"password",name:"password",placeholder:"M√≠nimo 8 caracteres",value:s.password,onChange:m,required:!0}),e.jsxs("div",{className:`password-strength strength-${M}`,children:[e.jsx("div",{className:"strength-bar"}),e.jsx("div",{className:"strength-bar"}),e.jsx("div",{className:"strength-bar"}),e.jsx("div",{className:"strength-bar"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"confirm_password",children:[e.jsx(ne,{className:"input-icon"})," Confirmar contrase√±a ",e.jsx("span",{className:"required",children:"*"})]}),e.jsx("input",{type:"password",id:"confirm_password",name:"confirm_password",placeholder:"Repita la contrase√±a",value:s.confirm_password,onChange:m,required:!0})]})]}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:c,children:c?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"loading-icon"})," Procesando..."]}):"Registrar Personal"})]})]})})}const vs=1e4;function Ns(){const[s,u]=i.useState({vehiculo_id:"",kilometros_recorridos:"",tipo_combustible:"",fecha:new Date().toISOString().split("T")[0],costo_combustible:""}),[_,V]=i.useState([]),[c,x]=i.useState(!1),[v,q]=i.useState(!0),[l,S]=i.useState(null),[M,D]=i.useState(!1),[p,L]=i.useState(null),[E,j]=i.useState(null),t=15e3;i.useEffect(()=>{(async()=>{q(!0);try{const{data:A,error:z}=await C.from("vehicles").select("id, model, plate, fuel_types").order("model",{ascending:!0});if(z)throw z;const n=(A||[]).map(d=>{let y=["Diesel"];try{d.fuel_types&&(y=d.fuel_types.replace(/[\[\]"]/g,"").split(",").map(H=>H.trim()))}catch(H){console.error("Error parsing fuel_types:",H)}return{...d,fuel_types:y}});V(n)}catch(A){S("Error al cargar veh√≠culos: "+A.message)}finally{q(!1)}})()},[]);const r=async F=>{try{const{data:A,error:z}=await C.from("vehicle_mileage").select("*").eq("vehicle_id",F).single();if(z&&z.code!=="PGRST116")throw z;const n=A||{vehicle_id:F,total_kilometers:0};j(n),n.total_kilometers>t&&w(`¬°Atenci√≥n! Este veh√≠culo ya ha superado el l√≠mite de ${t} km (actual: ${n.total_kilometers} km). Por favor, realice el cambio de aceite lo antes posible.`)}catch(A){console.error("Error fetching vehicle mileage:",A),j({vehicle_id:F,total_kilometers:0})}},w=F=>{L(F);const A=setTimeout(()=>{L(null)},vs);return()=>clearTimeout(A)},m=F=>{const{name:A,value:z}=F.target;u(n=>({...n,[A]:z}))},T=F=>{const A=F.target.value,z=_.find(n=>n.id===A);z&&(u(n=>({...n,vehiculo_id:A,tipo_combustible:z.fuel_types[0],costo_combustible:""})),r(A))},h=async F=>{if(F.preventDefault(),S(null),D(!1),L(null),!s.vehiculo_id||!s.kilometros_recorridos||!s.fecha||!s.tipo_combustible||!s.costo_combustible){S("Por favor complete todos los campos obligatorios");return}const A=parseFloat(s.kilometros_recorridos),z=parseFloat(s.costo_combustible);if(A<=0){S("Los kil√≥metros recorridos deben ser mayor a cero");return}if(z<=0){S("El costo debe ser mayor a cero");return}E&&E.total_kilometers+A>t&&w(`Advertencia: El total acumulado ser√° de ${E.total_kilometers+A} km (l√≠mite: ${t} km). Por favor, programe el cambio de aceite pronto.`),x(!0);try{const{error:n}=await C.from("fuel").insert([{vehiculo_id:s.vehiculo_id,kilometraje:A,tipo:s.tipo_combustible,fecha:s.fecha,costo:z,litros:0}]);if(n)throw n;D(!0),u(d=>({...d,kilometros_recorridos:"",costo_combustible:"",fecha:new Date().toISOString().split("T")[0]})),E&&j({...E,total_kilometers:E.total_kilometers+A}),setTimeout(()=>D(!1),3e3)}catch(n){console.error("Error al registrar:",n),S("Error al registrar: "+(n.message||"Intente nuevamente"))}finally{x(!1)}},k=_.find(F=>F.id===s.vehiculo_id),P=(k==null?void 0:k.fuel_types)||[];return e.jsx("div",{className:"fuel-record-container",children:e.jsxs("div",{className:"form-card",children:[e.jsxs("div",{className:"form-header",children:[e.jsx(X,{className:"form-icon"}),e.jsx("h2",{children:"Registro de Combustible y Kilometraje"}),e.jsx("p",{className:"form-subtitle",children:"Complete los datos del veh√≠culo y combustible"})]}),l&&e.jsxs("div",{className:"alert error",children:[e.jsx(ie,{className:"alert-icon"}),e.jsx("span",{children:l})]}),p&&e.jsxs("div",{className:"alert warning",children:[e.jsx(ie,{className:"alert-icon"}),e.jsx("span",{children:p})]}),M&&e.jsxs("div",{className:"alert success",children:[e.jsx(re,{className:"alert-icon"}),e.jsx("span",{children:"Registro completado exitosamente"})]}),e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{className:"form-grid",children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(Q,{className:"section-icon"}),"Veh√≠culo"]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"vehiculo_id",children:["Veh√≠culo ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(Q,{className:"input-icon"}),e.jsxs("select",{id:"vehiculo_id",name:"vehiculo_id",value:s.vehiculo_id,onChange:T,disabled:v,required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Seleccione un veh√≠culo..."}),v?e.jsx("option",{disabled:!0,children:"Cargando veh√≠culos..."}):_.map(F=>e.jsxs("option",{value:F.id,children:[F.model," - ",F.plate]},F.id))]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"kilometros_recorridos",children:["Kil√≥metros recorridos ",e.jsx("span",{className:"required",children:"*"}),E&&e.jsxs("span",{className:"mileage-hint",children:["(Total acumulado: ",E.total_kilometers," km)"]})]}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(Fe,{className:"input-icon"}),e.jsx("input",{id:"kilometros_recorridos",name:"kilometros_recorridos",type:"number",placeholder:"Ej: 150 (km de este viaje)",value:s.kilometros_recorridos,onChange:m,min:"1",step:"1",required:!0})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h3",{className:"section-title",children:[e.jsx(X,{className:"section-icon"}),"Combustible"]}),s.vehiculo_id&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"tipo_combustible",children:["Tipo de combustible ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(X,{className:"input-icon"}),e.jsx("select",{id:"tipo_combustible",name:"tipo_combustible",value:s.tipo_combustible,onChange:m,required:!0,children:P.map((F,A)=>e.jsx("option",{value:F,children:F},A))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"costo_combustible",children:["Costo combustible (‚Ç¨) ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(oe,{className:"input-icon"}),e.jsx("input",{id:"costo_combustible",name:"costo_combustible",type:"number",placeholder:"Ej: 65.50",value:s.costo_combustible,onChange:m,min:"0.01",step:"0.01",required:!0})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"fecha",children:["Fecha ",e.jsx("span",{className:"required",children:"*"})]}),e.jsxs("div",{className:"input-with-icon",children:[e.jsx(Y,{className:"input-icon"}),e.jsx("input",{id:"fecha",name:"fecha",type:"date",value:s.fecha,onChange:m,max:new Date().toISOString().split("T")[0],required:!0})]})]})]})]})]}),e.jsx("div",{className:"form-actions",children:e.jsx("button",{type:"submit",className:"submit-button",disabled:c||!s.vehiculo_id,children:c?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"spin"}),"Registrando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(re,{}),"Registrar Carga"]})})})]})]})})}function _s(){const[s,u]=i.useState([]),[_,V]=i.useState(!0),[c,x]=i.useState(null),[v,q]=i.useState("month"),[l,S]=i.useState(!1),[M,D]=i.useState(null),[p,L]=i.useState({kilometraje:"",costo:"",fecha:""}),[E,j]=i.useState(null),[t,r]=i.useState(null),w=["Diesel","GNC","GLP","Gasolina"],m={Diesel:"#f5a623",GNC:"#bd10e0",GLP:"#4a90e2",Gasolina:"#7ed321",Electrico:"#50e3c2",Hibrido:"#b8e986",Total:"#3b82f6"};i.useEffect(()=>{(async()=>{const{data:{user:d}}=await C.auth.getUser();if(d){const{data:y,error:H}=await C.from("staff").select("id, rol").eq("auth_id",d.id).single();!H&&y?(j(y.rol.toLowerCase()),r(y.id)):j("admin")}})()},[]),i.useEffect(()=>{E!==null&&(async()=>{V(!0),x(null);try{let d=C.from("fuel").select(`
            id,
            vehiculo_id,
            kilometraje,
            tipo,
            costo,
            fecha,
            created_at,
            litros,
            vehiculo:vehiculo_id (
              model,
              plate,
              driver_id,
              staff:driver_id (
                full_name,
                id
              )
            )
          `).order("fecha",{ascending:!1});const y=new Date;let H=new Date;v==="day"?H.setDate(y.getDate()-1):v==="week"?H.setDate(y.getDate()-7):v==="month"?H.setMonth(y.getMonth()-1):v==="year"&&H.setFullYear(y.getFullYear()-1),v!=="all"&&(d=d.gte("fecha",H.toISOString()));const{data:B,error:o}=await d;if(o)throw o;const f=(B==null?void 0:B.map(G=>{var ee,se;const O=G.vehiculo;return{...G,vehiculo_model:O==null?void 0:O.model,vehiculo_plate:O==null?void 0:O.plate,vehiculo_staff:(ee=O==null?void 0:O.staff)==null?void 0:ee.full_name,vehiculo_driver_id:(se=O==null?void 0:O.staff)==null?void 0:se.id}}))||[],R=E==="staff"&&t?f.filter(G=>G.vehiculo_driver_id===t):f;u(R)}catch(d){console.error("Error al cargar registros:",d),x("Error al cargar los registros de combustible")}finally{V(!1)}})()},[v,E,t]);const T=s.reduce((n,d)=>{const y=d.tipo;return n[y]||(n[y]={total:0,count:0,kilometraje:0}),n[y].total+=d.costo,n[y].count+=1,n[y].kilometraje+=d.kilometraje||0,n},{}),h=Object.values(T).reduce((n,{total:d})=>n+d,0),k=n=>{const d=new Date(n);return new Date(d.getTime()+d.getTimezoneOffset()*6e4).toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit",year:"numeric"})},P=async n=>{if(!confirm("¬øSeguro que deseas eliminar este registro?"))return;const{error:d}=await C.from("fuel").delete().eq("id",n);d?alert("Error al eliminar"):u(s.filter(y=>y.id!==n))},F=n=>{D(n),L({kilometraje:n.kilometraje.toString(),costo:n.costo.toString(),fecha:n.fecha})},A=async()=>{if(!M)return;const{error:n}=await C.from("fuel").update({kilometraje:parseFloat(p.kilometraje),costo:parseFloat(p.costo),fecha:p.fecha}).eq("id",M.id);n?alert("Error al guardar cambios"):(u(s.map(d=>d.id===M.id?{...d,kilometraje:parseFloat(p.kilometraje),costo:parseFloat(p.costo),fecha:p.fecha}:d)),D(null))},z=()=>{const n=s.map(R=>({Modelo:R.vehiculo_model||"Desconocido",Placa:R.vehiculo_plate||"N/A",Conductor:R.vehiculo_staff||"N/A",Kilometraje:R.kilometraje,Tipo:R.tipo,Fecha:k(R.fecha),Costo:R.costo})),d=w.map(R=>{const G=T[R]||{total:0,count:0};return{Tipo:R,"Total Gastado":G.total,"Cantidad Repostajes":G.count}});d.push({Tipo:"TOTAL GENERAL","Total Gastado":h,"Cantidad Repostajes":s.length});const y=W.json_to_sheet([]);W.sheet_add_aoa(y,[["Reporte de Combustible"]],{origin:"A1"}),y["!merges"]=[{s:{r:0,c:0},e:{r:0,c:6}}],W.sheet_add_aoa(y,[["Detalle de Repostajes","","","","","","","Resumen por Tipo de Combustible"]],{origin:"A2"}),y["!merges"].push({s:{r:1,c:0},e:{r:1,c:6}},{s:{r:1,c:7},e:{r:1,c:10}}),W.sheet_add_aoa(y,[["Modelo","Placa","Conductor","Kilometraje","Tipo","Fecha","Costo (‚Ç¨)","Tipo","Total Gastado (‚Ç¨)","Cantidad Repostajes"]],{origin:"A3"}),W.sheet_add_json(y,n,{origin:"A4",skipHeader:!0}),W.sheet_add_json(y,d,{origin:"H4",skipHeader:!0}),y["!cols"]=[{wch:20},{wch:12},{wch:20},{wch:12},{wch:10},{wch:12},{wch:12},{wch:15},{wch:18},{wch:18}];const H=W.book_new();W.book_append_sheet(H,y,"Reporte Combustible");const B=ns(H,{bookType:"xlsx",type:"array"}),o=new Blob([B],{type:"application/octet-stream"}),f=new Date().toISOString().split("T")[0];rs.saveAs(o,`reporte_combustible_${f}.xlsx`)};return e.jsxs("div",{className:"fuel-report-container",children:[e.jsxs("div",{className:"report-header",children:[e.jsx(X,{className:"header-icon"}),e.jsx("h2",{children:"Reporte de Combustible"})]}),c&&e.jsxs("div",{className:"error-message",children:[e.jsx(we,{}),e.jsx("span",{children:c})]}),e.jsxs("div",{className:"controls",children:[e.jsxs("div",{className:"time-filter",children:[e.jsxs("label",{children:[e.jsx(Ke,{className:"filter-icon"}),"Per√≠odo:"]}),e.jsxs("select",{value:v,onChange:n=>q(n.target.value),children:[e.jsx("option",{value:"day",children:"√öltimo d√≠a"}),e.jsx("option",{value:"week",children:"√öltima semana"}),e.jsx("option",{value:"month",children:"√öltimo mes"}),e.jsx("option",{value:"year",children:"√öltimo a√±o"}),e.jsx("option",{value:"all",children:"Todos"})]})]}),e.jsx("button",{className:"toggle-details",onClick:()=>S(!l),children:l?"Ocultar detalles":"Mostrar detalles"}),E==="admin"&&e.jsx("button",{className:"export-button",onClick:z,children:"Exportar a Excel"})]}),_?e.jsxs("div",{className:"loading-indicator",children:[e.jsx(K,{className:"spin"}),e.jsx("span",{children:"Cargando reporte..."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card total",children:[e.jsx("div",{className:"card-icon",children:e.jsx(oe,{})}),e.jsxs("div",{className:"card-content",children:[e.jsx("h3",{children:"Total gastado"}),e.jsxs("p",{children:["‚Ç¨",h.toFixed(2)]})]})]}),e.jsxs("div",{className:"summary-card",children:[e.jsx("div",{className:"card-icon",children:e.jsx(De,{})}),e.jsxs("div",{className:"card-content",children:[e.jsx("h3",{children:"Repostajes"}),e.jsx("p",{children:s.length})]})]})]}),e.jsx("div",{className:"fuel-types",children:w.map(n=>{const d=T[n]||{total:0,count:0};return d.count>0&&e.jsxs("div",{className:"fuel-type-card",style:{borderLeft:`4px solid ${m[n]}`},children:[e.jsx("h3",{children:n}),e.jsxs("div",{className:"fuel-stats",children:[e.jsxs("div",{className:"fuel-stat",children:[e.jsx("span",{children:"Gasto:"}),e.jsxs("strong",{children:["‚Ç¨",d.total.toFixed(2)]})]}),e.jsxs("div",{className:"fuel-stat",children:[e.jsx("span",{children:"Repostajes:"}),e.jsx("strong",{children:d.count})]})]})]},n)})}),l&&e.jsxs("div",{className:"details-section",children:[e.jsxs("h3",{children:[e.jsx(Q,{}),e.jsx("span",{children:"Detalle de repostajes"})]}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"fuel-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Veh√≠culo"}),e.jsx("th",{children:"Placa"}),e.jsx("th",{children:"Conductor"}),e.jsx("th",{children:"Kilometraje"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Costo (‚Ç¨)"}),E==="admin"&&e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:s.length>0?s.map(n=>e.jsxs("tr",{children:[e.jsx("td",{children:n.vehiculo_model||"Veh√≠culo desconocido"}),e.jsx("td",{children:n.vehiculo_plate||"N/A"}),e.jsx("td",{children:n.vehiculo_staff||"N/A"}),e.jsxs("td",{children:[n.kilometraje.toLocaleString()," km"]}),e.jsx("td",{children:e.jsx("span",{className:"fuel-badge",style:{backgroundColor:m[n.tipo]},children:n.tipo})}),e.jsx("td",{children:k(n.fecha)}),e.jsxs("td",{children:["‚Ç¨",n.costo.toFixed(2)]}),E==="admin"&&e.jsxs("td",{children:[e.jsx("button",{onClick:()=>F(n),children:e.jsx(Ye,{})}),e.jsx("button",{onClick:()=>P(n.id),children:e.jsx(Ee,{})})]})]},n.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:8,children:"No hay registros en este per√≠odo"})})})]})})]}),e.jsx(ls,{children:M&&e.jsx(Ne.div,{className:"modal",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},children:e.jsxs(Ne.div,{className:"modal-content",initial:{y:-50,opacity:0},animate:{y:0,opacity:1},exit:{y:50,opacity:0},transition:{type:"spring",damping:25,stiffness:500},children:[e.jsx("h3",{children:"Editar Repostaje"}),e.jsxs("label",{children:["Fecha:",e.jsx("input",{type:"date",value:p.fecha.split("T")[0],onChange:n=>L({...p,fecha:n.target.value})})]}),e.jsxs("label",{children:["Kilometraje:",e.jsx("input",{type:"number",value:p.kilometraje,onChange:n=>L({...p,kilometraje:n.target.value})})]}),e.jsxs("label",{children:["Costo (‚Ç¨):",e.jsx("input",{type:"number",step:"0.01",value:p.costo,onChange:n=>L({...p,costo:n.target.value})})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{onClick:A,children:"Guardar"}),e.jsx("button",{onClick:()=>D(null),children:"Cancelar"})]})]})})})]})]})}const bs=()=>{const[s,u]=i.useState("Veh√≠culos"),[_,V]=i.useState(!1),[c,x]=i.useState(null),[v,q]=i.useState(!0),l=Ce();i.useEffect(()=>{(async()=>{var t;try{q(!0);const{data:{user:r},error:w}=await C.auth.getUser();if(w)throw w;if(!r)throw new Error("Usuario no autenticado");const{data:m,error:T}=await C.from("staff").select("id, full_name, username, rol, email, position").eq("auth_id",r.id).single();if(T)throw T;if(m)x({id:m.id,full_name:m.full_name||"Usuario",username:m.username||"sin_usuario",rol:m.rol||"Sin rol asignado",email:m.email||"",position:m.position||""});else{const{data:h,error:k}=await C.from("users").select("full_name, username, role").eq("auth_id",r.id).single();if(k)throw k;x({id:r.id,full_name:(h==null?void 0:h.full_name)||((t=r.email)==null?void 0:t.split("@")[0])||"Usuario",username:(h==null?void 0:h.username)||"sin_usuario",rol:(h==null?void 0:h.role)||"Usuario",email:r.email||"",position:""})}}catch(r){console.error("Error al obtener perfil:",r),x({id:"",full_name:"Usuario",username:"sin_usuario",rol:"Admin",email:"",position:""})}finally{q(!1)}})()},[]);const S=[{name:"Perfil",icon:e.jsx(Xe,{size:18}),component:e.jsx(us,{}),category:"perfil",roles:["staff"]},{name:"Veh√≠culos",icon:e.jsx(Q,{size:18}),component:e.jsx(hs,{}),category:"flota",roles:["admin","staff","supervisor"]},{name:"Registrar Veh√≠culo",icon:e.jsx(Fe,{size:18}),component:e.jsx(ps,{}),category:"flota",roles:["admin","supervisor"]},{name:"Personal",icon:e.jsx(Qe,{size:18}),component:e.jsx(xs,{}),category:"personal",roles:["admin","supervisor"]},{name:"Agregar Personal",icon:e.jsx(es,{size:18}),component:e.jsx(gs,{}),category:"personal",roles:["admin"]},{name:"Combustible",icon:e.jsx(X,{size:18}),component:e.jsx(Ns,{}),category:"operaciones",roles:["admin","staff","supervisor"]},{name:"Reportes",icon:e.jsx(De,{size:18}),component:e.jsx(_s,{}),category:"operaciones",roles:["admin","supervisor","staff"]}],D=c?S.filter(j=>!j.roles||j.roles.includes(c.rol.toLowerCase())):[],p=D.reduce((j,t)=>(j[t.category||"other"]||(j[t.category||"other"]=[]),j[t.category||"other"].push(t),j),{});i.useEffect(()=>{!v&&c&&!D.some(t=>t.name===s)&&D.length>0&&u(D[0].name)},[v,c,s,D]);const L=async()=>{try{await C.auth.signOut(),l("/login")}catch(j){console.error("Error al cerrar sesi√≥n:",j)}},E=()=>{const j=D.find(t=>t.name===s);return j?j.component:e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Seleccione una secci√≥n v√°lida"})};return e.jsxs("div",{className:"dashboard-container",children:[e.jsxs("aside",{className:"sidebar",children:[e.jsx("div",{className:"sidebar-header",children:e.jsx("div",{className:"logo-container",children:e.jsxs("h1",{className:"logo",children:["Positlogis",e.jsx("span",{children:"Gesti√≥n"})]})})}),e.jsx("nav",{className:"sidebar-nav",children:Object.entries(p).map(([j,t])=>e.jsxs("div",{className:"nav-category",children:[e.jsx("h3",{className:"category-title",children:j.toUpperCase()}),e.jsx("ul",{children:t.map(r=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>{u(r.name),V(!1)},className:`nav-item ${s===r.name?"active":""}`,children:[e.jsx("span",{className:"nav-icon",children:r.icon}),e.jsx("span",{className:"nav-text",children:r.name})]})},r.name))})]},j))}),e.jsx("div",{className:"sidebar-footer",children:e.jsxs("button",{onClick:L,className:"logout-button",children:[e.jsx(je,{size:18}),e.jsx("span",{children:"Cerrar sesi√≥n"})]})})]}),e.jsxs("div",{className:"main-content",children:[e.jsxs("header",{className:"mobile-header",children:[e.jsx("button",{onClick:()=>V(!_),className:"mobile-menu-button",children:e.jsxs("div",{className:`menu-icon ${_?"open":""}`,children:[e.jsx("span",{}),e.jsx("span",{}),e.jsx("span",{})]})}),e.jsx("h1",{className:"mobile-title",children:s}),!v&&c&&e.jsx("div",{className:"mobile-user-avatar",children:e.jsx(Z,{size:20})})]}),_&&e.jsx("div",{className:"mobile-menu-overlay",children:e.jsxs("div",{className:"mobile-menu",children:[e.jsxs("div",{className:"mobile-menu-header",children:[!v&&c&&e.jsxs("div",{className:"mobile-user-profile",children:[e.jsx("div",{className:"mobile-user-avatar large",children:e.jsx(Z,{size:24})}),e.jsxs("div",{className:"mobile-user-info",children:[e.jsx("span",{className:"mobile-user-name",children:c.full_name}),e.jsx("span",{className:"mobile-user-role",children:c.rol})]})]}),e.jsx("button",{onClick:()=>V(!1),className:"close-menu-button",children:"√ó"})]}),e.jsxs("nav",{className:"mobile-nav",children:[Object.entries(p).map(([j,t])=>e.jsxs("div",{className:"mobile-nav-category",children:[e.jsx("h3",{className:"mobile-category-title",children:j.toUpperCase()}),e.jsx("ul",{children:t.map(r=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>{u(r.name),V(!1)},className:`mobile-nav-item ${s===r.name?"active":""}`,children:[e.jsx("span",{className:"mobile-nav-icon",children:r.icon}),e.jsx("span",{children:r.name})]})},r.name))})]},j)),e.jsxs("button",{onClick:L,className:"mobile-logout-button",children:[e.jsx(je,{size:18}),e.jsx("span",{children:"Cerrar sesi√≥n"})]})]})]})}),e.jsxs("main",{className:"content-area",children:[e.jsxs("div",{className:"content-header",children:[e.jsxs("div",{className:"breadcrumbs",children:[e.jsx("span",{children:"Dashboard"}),e.jsx("span",{children:"/"}),e.jsx("span",{children:s})]}),!v&&c&&e.jsxs("div",{className:"user-welcome",children:["Hola, ",e.jsx("strong",{children:c.full_name})," (",c.rol,") ",c.position&&e.jsx("span",{className:"user-position",children:c.position})]})]}),e.jsx("div",{className:"content-card",children:E()})]})]})]})},ys=()=>{const[s,u]=i.useState(null);return i.useEffect(()=>{(async()=>{const{data:{session:c}}=await C.auth.getSession();u(c)})();const{data:V}=C.auth.onAuthStateChange((c,x)=>{u(x)});return()=>{V.subscription.unsubscribe()}},[]),{session:s}};function Cs(){const{session:s}=ys();return e.jsx(ss,{children:e.jsxs(as,{children:[e.jsx(ge,{path:"/",element:s?e.jsx(ve,{to:"/dashboard"}):e.jsx(ms,{})}),e.jsx(ge,{path:"/dashboard",element:s?e.jsx(bs,{}):e.jsx(ve,{to:"/"})})]})})}ts.createRoot(document.getElementById("root")).render(e.jsx(i.StrictMode,{children:e.jsx(Cs,{})}));
